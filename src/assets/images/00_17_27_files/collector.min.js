(()=>{"use strict";const t=t=>{return e=void 0,i=void 0,n=function*(){return new Promise(((e,i)=>{const s=new XMLHttpRequest,n=`https://plasm.me/api/v1/&/${t.path}`,o=JSON.stringify(t.payload);s.open(t.method,n,!0),s.setRequestHeader("Content-type","application/json"),s.setRequestHeader("Authorization",`Bearer ${t.authToken}`),s.onreadystatechange=()=>{if(4===s.readyState){const t=s.response?JSON.parse(s.response):{};200===s.status||201===s.status?e(t):i(t)}},s.send(o)}))},new((s=void 0)||(s=Promise))((function(t,o){function r(t){try{c(n.next(t))}catch(t){o(t)}}function a(t){try{c(n.throw(t))}catch(t){o(t)}}function c(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(r,a)}c((n=n.apply(e,i||[])).next())}));var e,i,s,n};var e,i,s,n;!function(t){t.started="started",t.stopped="stopped"}(e||(e={})),function(t){t.success="success",t.not_supported="not_supported",t.permission_denied="permission_denied",t.device_not_found="device_not_found"}(i||(i={})),function(t){t.camera="camera",t.screen="screen"}(s||(s={})),function(t){t.monitor="monitor",t.application="application",t.tab="tab",t.unknown="unknown"}(n||(n={}));var o=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}c((s=s.apply(t,e||[])).next())}))};class r{constructor(t,e){this.drawAndSendImage=()=>{const t=this.drawImage();this.sendImage(t)},this.drawImage=()=>{const{width:t,height:e}=this.IMAGE_DIMENSIONS;return this.context.clearRect(0,0,t,e),this.context.drawImage(this.video,0,0,t,e),this.canvas.toDataURL("image/jpeg").split(",")[1]},this.stop=()=>{clearTimeout(this.timerId),null!=this.stream&&this.stream.getTracks().forEach((t=>t.stop()))},r.validateOptions(t),this.options=t,this.plasmOptions=e}static validateOptions(t){if(t.interval<Number("100"))throw new Error('"interval" should greater than or equal 100')}setup(){return o(this,void 0,void 0,(function*(){this.setupDomElements();try{yield this.setupStream()}catch(t){switch(t.name){case"NotFoundError":return this.buildSetupResult(i.device_not_found);case"NotAllowedError":return this.buildSetupResult(i.permission_denied);default:throw t}}return this.buildSetupResult(i.success)}))}buildSetupResult(t){return{id:this.options.id,status:t,stream:this.stream,meta:this.getSetupMeta()}}setupDomElements(){this.video=document.createElement("video"),this.canvas=document.createElement("canvas"),this.canvas.width=this.IMAGE_DIMENSIONS.width,this.canvas.height=this.IMAGE_DIMENSIONS.height;const t=this.canvas.getContext("2d");if(null==t)throw new Error("canvas context cannot be created");this.context=t}start(t){return o(this,void 0,void 0,(function*(){this.sessionUuid=t,yield this.video.play(),this.drawAndSendImage(),this.startCollecting()}))}startCollecting(){this.timerId=setInterval(this.drawAndSendImage,this.options.interval)}}const a=r;var c=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}c((s=s.apply(t,e||[])).next())}))};class u extends a{constructor(t,e){super(t,e),this.IMAGE_DIMENSIONS={width:"320",height:"240"}}checkSupportAndSetup(){return c(this,void 0,void 0,(function*(){return!1===u.checkIsSupported()?this.buildSetupResult(i.not_supported):this.setup()}))}static checkIsSupported(){var t,e;return void 0!==(null===(e=null===(t=navigator)||void 0===t?void 0:t.mediaDevices)||void 0===e?void 0:e.getUserMedia)}getSetupMeta(){return{}}setupStream(){return c(this,void 0,void 0,(function*(){return this.stream=yield navigator.mediaDevices.getUserMedia({audio:!1,video:!0}),this.video.srcObject=this.stream,new Promise((t=>{this.video.oncanplay=()=>t()}))}))}sendImage(e){return c(this,void 0,void 0,(function*(){const i={sessionUuid:this.sessionUuid,image:e};yield t({authToken:this.plasmOptions.clientToken,method:"POST",path:"snapshots",payload:i}),this.plasmOptions.debug&&console.log(`[PLASM] ${(new Date).toISOString()} - snapshot created`)}))}}const d=u;var h=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}c((s=s.apply(t,e||[])).next())}))};class l extends a{constructor(t,e){super(t,e),this.IMAGE_DIMENSIONS={width:"640",height:"400"}}checkSupportAndSetup(){return h(this,void 0,void 0,(function*(){return!1===l.checkIsSupported()?this.buildSetupResult(i.not_supported):this.setup()}))}static checkIsSupported(){var t,e;return void 0!==(null===(e=null===(t=navigator)||void 0===t?void 0:t.mediaDevices)||void 0===e?void 0:e.getDisplayMedia)}getSetupMeta(){return{selectedArea:this.getSelectedArea()}}getSelectedArea(){var t,e,i;if(null==this.stream)return n.unknown;const s=this.stream.getVideoTracks()[0],{label:o}=s,r=s.getSettings();return"monitor"===(null===(t=r)||void 0===t?void 0:t.displaySurface)||"Primary Monitor"===o?n.monitor:"window"===(null===(e=r)||void 0===e?void 0:e.displaySurface)||o.includes("Mozilla Firefox")?n.application:"browser"===(null===(i=r)||void 0===i?void 0:i.displaySurface)?n.tab:"safari"===(()=>{let t;const e=navigator.userAgent;return t=e.indexOf("Firefox")>-1?"firefox":e.indexOf("SamsungBrowser")>-1?"samsung-internet":e.indexOf("Opera")>-1||e.indexOf("OPR")>-1?"opera":e.indexOf("Trident")>-1?"ie":e.indexOf("Edge")>-1?"edge":e.indexOf("Chrome")>-1?"chrome":e.indexOf("Safari")>-1?"safari":"unknown",t})()?n.monitor:n.unknown}setupStream(){return h(this,void 0,void 0,(function*(){return this.stream=yield navigator.mediaDevices.getDisplayMedia(),this.video.srcObject=this.stream,new Promise((t=>{this.video.oncanplay=()=>t()}))}))}sendImage(e){return h(this,void 0,void 0,(function*(){const i={sessionUuid:this.sessionUuid,image:e};yield t({authToken:this.plasmOptions.clientToken,method:"POST",path:"screenshots",payload:i}),this.plasmOptions.debug&&console.log(`[PLASM] ${(new Date).toISOString()} - screenshot created`)}))}}const p=l;var v=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}c((s=s.apply(t,e||[])).next())}))};class f{constructor(t){this.state=e.stopped,this.collectors=[],this.configuredCollectors=[],f.validateOptions(t),this.options=t,this.supportedCollectors=f.getSupportedCollectors(),t.sessionUuid&&(this.sessionUuid=t.sessionUuid)}static validateOptions(t){if(t.expiresIn<1)throw new Error('"expiresIn" should be greater than or equal 1')}static getSupportedCollectors(){const t=[];return Object.keys(s).forEach((e=>{switch(e){case s.camera:!0===d.checkIsSupported()&&t.push(e);break;case s.screen:!0===p.checkIsSupported()&&t.push(e)}})),t}setupCollector(t){return v(this,void 0,void 0,(function*(){this.cleanUpBeforeCollectorSetup(t);const e=this.createCollector(t);this.collectors.push(e);const s=yield e.checkSupportAndSetup();return s.status===i.success&&this.configuredCollectors.push(e),s}))}cleanUpBeforeCollectorSetup(t){const e=this.configuredCollectors.find((e=>e.options.id===t.id));void 0!==e&&e.stop(),this.collectors=this.collectors.filter((e=>e.options.id!==t.id)),this.configuredCollectors=this.configuredCollectors.filter((e=>e.options.id!==t.id))}createCollector(t){switch(t.id){case s.camera:return new d(t,this.options);case s.screen:return new p(t,this.options);default:throw new Error("[PLASM] unknown collector id")}}start(){return v(this,void 0,void 0,(function*(){switch(yield this.prepareStart(),this.state){case e.started:console.warn("[PLASM] already started");break;case e.stopped:yield Promise.all(this.configuredCollectors.map((t=>t.start(this.sessionUuid)))),this.state=e.started,this.options.debug&&console.log("[PLASM] started")}return this.sessionUuid}))}prepareStart(){return v(this,void 0,void 0,(function*(){this.validateStart(),yield this.prepareSession()}))}validateStart(){if(0===this.configuredCollectors.length)throw new Error("[PLASM] can not start: no configured collectors")}prepareSession(){return v(this,void 0,void 0,(function*(){if(void 0===this.sessionUuid){const t=yield this.createSessionRequest();this.sessionUuid=t.uuid}}))}stop(){return v(this,void 0,void 0,(function*(){this.state!==e.stopped&&(this.configuredCollectors.forEach((t=>t.stop())),this.options.debug&&console.log("[PLASM] stopped"),this.state=e.stopped)}))}createSessionRequest(){return v(this,void 0,void 0,(function*(){const e={expiresIn:this.options.expiresIn};return t({authToken:this.options.clientToken,method:"POST",path:"sessions",payload:e})}))}}window.Plasm=f})();
//# sourceMappingURL=collector.min.js.map